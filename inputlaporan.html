<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Kegiatan POMG</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- jsPDF CDN for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, query, where, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');
        
        // GLOBAL VARIABLES from Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let transactions = [];
        let financeChart;
        let currentChartPeriod = 'daily';

        // Listen for changes in the financial data for the current user
        const setupFinanceListener = () => {
            if (!window.userId()) {
                console.warn("User not authenticated, cannot set up finance listener.");
                return;
            }

            const financeColRef = window.collection(window.db, `artifacts/${window.appId}/users/${window.userId()}/financial_reports`);
            window.onSnapshot(financeColRef, (snapshot) => {
                const data = [];
                snapshot.forEach(doc => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                updateUI(data);
                renderTable(data);
            }, (error) => {
                console.error("Error fetching financial data: ", error);
            });
        };

        // Listen for changes in the users data (Public for simplicity)
        const setupUsersListener = () => {
            if (!window.userId()) {
                console.warn("User not authenticated, cannot set up users listener.");
                return;
            }
            // Mengubah jalur koleksi pengguna dari publik ke jalur privat yang terikat pada userId
            // Ini mengatasi masalah izin Firebase.
            const usersColRef = window.collection(window.db, `artifacts/${window.appId}/users/${window.userId()}/users`);
            window.onSnapshot(usersColRef, (snapshot) => {
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                renderUsersTable(users);
            }, (error) => {
                console.error("Error fetching users data: ", error);
            });
        };

        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    isAuthReady = true;
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated user:", userId);
                        // Setup listeners only after successful authentication
                        setupFinanceListener();
                        setupUsersListener();
                    } else {
                        userId = null;
                        console.log("User signed out or authentication failed.");
                    }
                });
                
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                }
            } else {
                console.error("Firebase config is missing.");
            }
        };

        initFirebase();

        // Pass variables to global scope for use in other script blocks
        window.appId = appId;
        window.db = db;
        window.auth = auth;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.where = where;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.userId = () => auth.currentUser?.uid;
        window.isAuthReady = () => isAuthReady;
        window.financeChart = null; // Initialize chart variable globally
        window.currentChartPeriod = currentChartPeriod;
        window.updateChart = updateChart;
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fff4; /* Light green background */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col lg:flex-row">

    <!-- Sidebar Navigasi -->
    <aside class="bg-white text-gray-800 w-full lg:w-64 p-6 shadow-md rounded-lg lg:rounded-l-lg lg:rounded-r-none fixed lg:relative z-10 bottom-0 lg:bottom-auto">
        <div class="flex items-center justify-between lg:justify-start lg:block">
            <!-- Logo POMG -->
            <div class="mb-4 text-center">
                <img src="https://placehold.co/100x100/30674e/ffffff?text=LOGO+POMG" alt="Logo POMG" class="mx-auto rounded-full mb-2 w-24 h-24 object-cover">
                <h1 class="text-2xl font-bold text-gray-900">POMG Aljabbar</h1>
            </div>
            <nav class="flex justify-around w-full lg:flex-col lg:space-y-4">
                <a href="#" id="nav-dashboard" class="flex flex-col lg:flex-row items-center justify-center lg:justify-start px-4 py-2 text-gray-600 hover:text-blue-600 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 lg:mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span class="text-sm lg:text-base">Dashboard</span>
                </a>
                <a href="#" id="nav-input" class="flex flex-col lg:flex-row items-center justify-center lg:justify-start px-4 py-2 text-gray-600 hover:text-blue-600 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 lg:mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <span class="text-sm lg:text-base">Input Data</span>
                </a>
                <a href="#" id="nav-laporan" class="flex flex-col lg:flex-row items-center justify-center lg:justify-start px-4 py-2 text-gray-600 hover:text-blue-600 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 lg:mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-4m0-4h.01M9 8h.01M17 17v-4m0-4h.01M17 8h.01M12 17v-4m0-4h.01M12 8h.01M3 21h18a2 2 0 002-2V5a2 2 0 00-2-2H3a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    <span class="text-sm lg:text-base">Laporan</span>
                </a>
                <a href="#" id="nav-pengaturan" class="flex flex-col lg:flex-row items-center justify-center lg:justify-start px-4 py-2 text-gray-600 hover:text-blue-600 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 lg:mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-sm lg:text-base">Pengaturan Pengguna</span>
                </a>
                <a href="#" id="keluar-btn" class="flex flex-col lg:flex-row items-center justify-center lg:justify-start px-4 py-2 text-gray-600 hover:text-blue-600 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 lg:mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-sm lg:text-base">Keluar</span>
                </a>
                <script>
                document.getElementById("keluar-btn").addEventListener("click", function(e) {
                e.preventDefault(); // cegah default behavior <a>
                window.location.href = "index.html"; // arahkan ke halaman login
                });
                </script>
            </nav>
        </div>
        <div class="mt-4 lg:mt-8 p-2 rounded-lg bg-gray-200 text-xs text-gray-700 text-center break-words">
            User ID: <span id="user-id-display" class="font-mono font-bold"></span>
        </div>
    </aside>

    <!-- Konten Utama -->
    <main class="flex-1 p-6 lg:p-10 pb-20 lg:pb-10">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2 sm:mb-0">Dashboard Keuangan</h1>
            <p class="text-gray-500">Selamat datang kembali, Staff Keuangan.</p>
        </header>

        <!-- Bagian Dashboard -->
        <section id="dashboard-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-gray-500 text-sm font-semibold uppercase tracking-wider">Total Pemasukan</h2>
                <p id="total-income" class="text-3xl font-bold text-green-600 mt-1">Rp 0</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-gray-500 text-sm font-semibold uppercase tracking-wider">Total Pengeluaran</h2>
                <p id="total-expense" class="text-3xl font-bold text-red-600 mt-1">Rp 0</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-gray-500 text-sm font-semibold uppercase tracking-wider">Total Saldo</h2>
                <p id="total-balance" class="text-3xl font-bold text-blue-600 mt-1">Rp 0</p>
            </div>
            <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-gray-500 text-sm font-semibold uppercase tracking-wider">Saran Anggaran ✨</h2>
                <p id="budget-suggestion" class="text-gray-700 mt-2">Tekan tombol di bawah untuk mendapatkan saran alokasi anggaran bulanan.</p>
                <button id="generate-budget-btn" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    <span id="generate-budget-text">Dapatkan Saran Anggaran ✨</span>
                    <span id="generate-budget-loading" class="hidden">
                        <svg class="animate-spin h-5 w-5 text-white inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Memuat...
                    </span>
                </button>
            </div>
        </section>

        <!-- Bagian Grafik -->
        <section id="grafik-section" class="bg-white p-6 rounded-2xl shadow-md mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Grafik Pemasukan & Pengeluaran</h2>
                <div class="flex rounded-full bg-gray-200 p-1">
                    <button id="daily-btn" class="py-1 px-4 text-sm font-semibold rounded-full transition-colors duration-300 bg-blue-600 text-white">Harian</button>
                    <button id="monthly-btn" class="py-1 px-4 text-sm font-semibold rounded-full transition-colors duration-300 text-gray-700">Bulanan</button>
                </div>
            </div>
            <div class="h-80">
                <canvas id="financeChart"></canvas>
            </div>
        </section>

        <!-- Bagian Input Data -->
        <section id="input-section" class="bg-white p-6 rounded-2xl shadow-md hidden">
            <h2 class="text-xl font-bold mb-4">Input Laporan Keuangan</h2>
            <form id="finance-form" class="space-y-4">
                <div>
                    <label for="date" class="block text-gray-700 font-medium mb-1">Tanggal</label>
                    <input type="date" id="date" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="category" class="block text-gray-700 font-medium mb-1">Kategori</label>
                    <select id="category" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="Pemasukan">Pemasukan</option>
                        <option value="Pengeluaran">Pengeluaran</option>
                    </select>
                </div>
                <div>
                    <label for="amount" class="block text-gray-700 font-medium mb-1">Nominal (Rp)</label>
                    <input type="number" id="amount" required min="1" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="description" class="block text-gray-700 font-medium mb-1">Deskripsi</label>
                    <textarea id="description" rows="3" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">Simpan Laporan</button>
            </form>
            <div class="mt-8 pt-8 border-t border-gray-200">
                <h3 class="text-lg font-bold mb-4">Impor Laporan dari CSV</h3>
                <input type="file" id="csv-file-input" accept=".csv" class="mb-4">
                <button id="import-csv-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200">
                    <span id="import-csv-text">Impor Data dari CSV</span>
                    <span id="import-csv-loading" class="hidden">
                        <svg class="animate-spin h-5 w-5 text-white inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Memuat...
                    </span>
                </button>
                <a id="download-csv-sample" href="#" class="block text-center mt-2 text-sm text-blue-600 hover:underline">Unduh Contoh CSV</a>
            </div>
        </section>

        <!-- Bagian Laporan dan Tabel -->
        <section id="laporan-section" class="bg-white p-6 rounded-2xl shadow-md hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Daftar Transaksi</h2>
                <button id="analyze-report-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                    <span id="analyze-report-text">Analisis Laporan ✨</span>
                    <span id="analyze-report-loading" class="hidden">
                        <svg class="animate-spin h-5 w-5 text-white inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Memuat...
                    </span>
                </button>
            </div>
            
            <div id="analysis-result" class="bg-gray-50 border-l-4 border-purple-500 text-gray-700 p-4 rounded-md mb-4 hidden">
                <h3 class="font-semibold text-purple-800 mb-2">Analisis Gemini:</h3>
                <p id="analysis-text" class="text-sm"></p>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0">
                <div class="flex items-center space-x-2 w-full sm:w-auto">
                    <label for="filter-date" class="text-sm font-medium text-gray-700">Filter:</label>
                    <input type="date" id="filter-date" class="border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                </div>
                <div class="flex space-x-2 mt-4 sm:mt-0">
                    <button id="export-pdf" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200">Ekspor PDF</button>
                    <button id="export-csv" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-200">Ekspor Excel (CSV)</button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nominal (Rp)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="finance-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be populated here by JavaScript -->
                        <tr id="loading-row">
                            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
                <p id="no-data-message" class="text-center text-gray-500 mt-4 hidden">Tidak ada data transaksi.</p>
            </div>
        </section>

        <!-- Bagian Pengaturan Pengguna -->
        <section id="pengaturan-pengguna-section" class="bg-white p-6 rounded-2xl shadow-md hidden">
            <h2 class="text-xl font-bold mb-4">Pengaturan Pengguna</h2>
            <p class="text-gray-500 mb-4">Kelola daftar pengguna yang dapat mengakses laporan keuangan.</p>

            <form id="user-form" class="space-y-4 mb-8">
                <input type="hidden" id="user-id">
                <div>
                    <label for="username" class="block text-gray-700 font-medium mb-1">Nama Pengguna</label>
                    <input type="text" id="username" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="user-role" class="block text-gray-700 font-medium mb-1">Peran</label>
                    <select id="user-role" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="Admin">Admin</option>
                        <option value="Staff">Staff</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">Simpan Pengguna</button>
            </form>

            <h3 class="text-lg font-bold mb-4">Daftar Pengguna</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Pengguna</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pengguna</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peran</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                        <tr id="users-loading-row">
                            <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Memuat data pengguna...</td>
                        </tr>
                    </tbody>
                </table>
                <p id="no-users-message" class="text-center text-gray-500 mt-4 hidden">Tidak ada data pengguna.</p>
            </div>
        </section>
    </main>
    
    <!-- Modal untuk Edit/Hapus Transaksi -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center p-4 z-20">
        <div class="relative bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Edit Transaksi</h3>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label for="edit-date" class="block text-gray-700 font-medium mb-1">Tanggal</label>
                    <input type="date" id="edit-date" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="edit-category" class="block text-gray-700 font-medium mb-1">Kategori</label>
                    <select id="edit-category" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="Pemasukan">Pemasukan</option>
                        <option value="Pengeluaran">Pengeluaran</option>
                    </select>
                </div>
                <div>
                    <label for="edit-amount" class="block text-gray-700 font-medium mb-1">Nominal (Rp)</label>
                    <input type="number" id="edit-amount" required min="1" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="edit-description" class="block text-gray-700 font-medium mb-1">Deskripsi</label>
                    <textarea id="edit-description" rows="3" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="close-modal" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors duration-200">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center p-4 z-30">
        <div class="relative bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4" id="confirm-title">Konfirmasi Hapus</h3>
            <p class="text-gray-700 mb-4" id="confirm-message">Apakah Anda yakin ingin menghapus data ini?</p>
            <div class="flex justify-end space-x-2">
                <button id="confirm-cancel" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors duration-200">Batal</button>
                <button id="confirm-ok" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-200">Hapus</button>
            </div>
        </div>
    </div>

<script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        // Mendapatkan elemen-elemen DOM
        const navDashboard = document.getElementById('nav-dashboard');
        const navInput = document.getElementById('nav-input');
        const navLaporan = document.getElementById('nav-laporan');
        const navPengaturan = document.getElementById('nav-pengaturan');
        const dashboardSection = document.getElementById('dashboard-section');
        const grafikSection = document.getElementById('grafik-section');
        const inputSection = document.getElementById('input-section');
        const laporanSection = document.getElementById('laporan-section');
        const pengaturanPenggunaSection = document.getElementById('pengaturan-pengguna-section');
        const financeForm = document.getElementById('finance-form');
        const financeTableBody = document.getElementById('finance-table-body');
        const usersTableBody = document.getElementById('users-table-body');
        const filterDateInput = document.getElementById('filter-date');
        const exportPdfBtn = document.getElementById('export-pdf');
        const exportCsvBtn = document.getElementById('export-csv');
        const modal = document.getElementById('modal');
        const closeModalBtn = document.getElementById('close-modal');
        const editForm = document.getElementById('edit-form');
        const userForm = document.getElementById('user-form');
        const dailyBtn = document.getElementById('daily-btn');
        const monthlyBtn = document.getElementById('monthly-btn');
        const analyzeReportBtn = document.getElementById('analyze-report-btn');
        const analyzeReportLoading = document.getElementById('analyze-report-loading');
        const analyzeReportText = document.getElementById('analyze-report-text');
        const analysisResultDiv = document.getElementById('analysis-result');
        const analysisTextEl = document.getElementById('analysis-text');
        const generateBudgetBtn = document.getElementById('generate-budget-btn');
        const generateBudgetText = document.getElementById('generate-budget-text');
        const generateBudgetLoading = document.getElementById('generate-budget-loading');
        const budgetSuggestionEl = document.getElementById('budget-suggestion');
        const csvFileInput = document.getElementById('csv-file-input');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const importCsvText = document.getElementById('import-csv-text');
        const importCsvLoading = document.getElementById('import-csv-loading');
        const downloadCsvSample = document.getElementById('download-csv-sample');
        
        // Fungsi untuk show/hide a confirmation modal
        const showConfirmModal = (message, title, onConfirm) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = message;
            
            const confirmOk = document.getElementById('confirm-ok');
            const confirmCancel = document.getElementById('confirm-cancel');

            const handleOk = () => {
                onConfirm();
                modal.classList.add('hidden');
                confirmOk.removeEventListener('click', handleOk);
                confirmCancel.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                modal.classList.add('hidden');
                confirmOk.removeEventListener('click', handleOk);
                confirmCancel.removeEventListener('click', handleCancel);
            };

            confirmOk.addEventListener('click', handleOk);
            confirmCancel.addEventListener('click', handleCancel);
            modal.classList.remove('hidden');
        };

        // Fungsi untuk menampilkan atau menyembunyikan bagian konten
        const showSection = (sectionId) => {
            const sections = [dashboardSection, grafikSection, inputSection, laporanSection, pengaturanPenggunaSection];
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
            if (sectionId === 'dashboard-section') {
                grafikSection.classList.remove('hidden');
            }
        };

        // Mengatur event listener untuk navigasi
        navDashboard.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('dashboard-section');
        });
        navInput.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('input-section');
        });
        navLaporan.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('laporan-section');
        });
        navPengaturan.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('pengaturan-pengguna-section');
        });

        // Fungsi untuk merender tabel laporan keuangan
        const renderTable = (data) => {
            const financeTableBody = document.getElementById('finance-table-body');
            const noDataMessage = document.getElementById('no-data-message');
            const loadingRow = document.getElementById('loading-row');
            if (loadingRow) loadingRow.style.display = 'none';
            financeTableBody.innerHTML = '';
            
            if (data.length === 0) {
                noDataMessage.classList.remove('hidden');
                return;
            } else {
                noDataMessage.classList.add('hidden');
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${item.category === 'Pemasukan' ? 'text-green-600' : 'text-red-600'}">${item.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Rp ${item.amount.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button data-id="${item.id}" class="edit-btn text-blue-600 hover:text-blue-900">Edit</button>
                        <button data-id="${item.id}" class="delete-btn text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                financeTableBody.appendChild(row);
            });
        };

        const renderUsersTable = (users) => {
            const loadingRow = document.getElementById('users-loading-row');
            if (loadingRow) loadingRow.style.display = 'none';
            const noUsersMessage = document.getElementById('no-users-message');
            const usersTableBody = document.getElementById('users-table-body');
            usersTableBody.innerHTML = '';
            if (users.length === 0) {
                noUsersMessage.classList.remove('hidden');
                return;
            } else {
                noUsersMessage.classList.add('hidden');
            }
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button data-id="${user.id}" data-username="${user.username}" data-role="${user.role}" class="edit-user-btn text-blue-600 hover:text-blue-900">Edit</button>
                        <button data-id="${user.id}" class="delete-user-btn text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            });
        };

        // Fungsi untuk meng-update dashboard dan grafik
        const updateUI = (data) => {
            const totalIncomeEl = document.getElementById('total-income');
            const totalExpenseEl = document.getElementById('total-expense');
            const totalBalanceEl = document.getElementById('total-balance');
            const userIdDisplay = document.getElementById('user-id-display');

            userIdDisplay.textContent = window.userId() || 'N/A';

            let totalIncome = 0;
            let totalExpense = 0;
            
            data.forEach(item => {
                if (item.category === 'Pemasukan') {
                    totalIncome += item.amount;
                } else {
                    totalExpense += item.amount;
                }
            });

            const totalBalance = totalIncome - totalExpense;

            totalIncomeEl.textContent = `Rp ${totalIncome.toLocaleString('id-ID')}`;
            totalExpenseEl.textContent = `Rp ${totalExpense.toLocaleString('id-ID')}`;
            totalBalanceEl.textContent = `Rp ${totalBalance.toLocaleString('id-ID')}`;
            
            transactions = data.sort((a, b) => new Date(a.date) - new Date(b.date));
            updateChart();
        };

        const updateChart = () => {
            const { labels, incomeData, expenseData } = processChartData();
            const chartCanvas = document.getElementById('financeChart');
            
            if (financeChart) {
                financeChart.destroy();
            }

            const ctx = chartCanvas.getContext('2d');
            financeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pemasukan',
                        data: incomeData,
                        backgroundColor: 'rgba(52, 211, 153, 0.8)',
                        borderColor: 'rgb(52, 211, 153)',
                        borderWidth: 1,
                        borderRadius: 6
                    }, {
                        label: 'Pengeluaran',
                        data: expenseData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: 'rgb(239, 68, 68)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: Rp ${context.raw.toLocaleString('id-ID')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: currentChartPeriod === 'daily' ? 'day' : 'month',
                                tooltipFormat: currentChartPeriod === 'daily' ? 'MMM d' : 'MMM yyyy',
                                displayFormats: {
                                    day: 'MMM d',
                                    month: 'MMM yyyy'
                                }
                            },
                            title: {
                                display: true,
                                text: currentChartPeriod === 'daily' ? 'Tanggal' : 'Bulan'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nominal (Rp)'
                            }
                        }
                    }
                }
            });
        };

        const processChartData = () => {
            const now = new Date();
            const totals = {};

            if (currentChartPeriod === 'daily') {
                for (let i = 29; i >= 0; i--) {
                    const d = new Date(now);
                    d.setDate(now.getDate() - i);
                    const dateStr = d.toISOString().slice(0, 10);
                    totals[dateStr] = { income: 0, expense: 0, dateObj: d };
                }
            } else { // monthly
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(now);
                    d.setMonth(now.getMonth() - i);
                    const monthStr = d.toISOString().slice(0, 7);
                    totals[monthStr] = { income: 0, expense: 0, dateObj: d };
                }
            }

            transactions.forEach(t => {
                let key;
                if (currentChartPeriod === 'daily') {
                    key = t.date;
                } else {
                    key = t.date.substring(0, 7);
                }
                if (totals[key]) {
                    if (t.category === 'Pemasukan') {
                        totals[key].income += t.amount;
                    } else {
                        totals[key].expense += t.amount;
                    }
                }
            });

            const labels = Object.keys(totals).sort().map(key => totals[key].dateObj);
            const incomeData = Object.keys(totals).sort().map(key => totals[key].income);
            const expenseData = Object.keys(totals).sort().map(key => totals[key].expense);

            return { labels, incomeData, expenseData };
        };

        // Event listener untuk form input data keuangan
        financeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('date').value;
            const category = document.getElementById('category').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;

            try {
                const financeColRef = window.collection(window.db, `artifacts/${window.appId}/users/${window.userId()}/financial_reports`);
                await window.addDoc(financeColRef, {
                    date,
                    category,
                    amount,
                    description,
                    createdAt: new Date().toISOString()
                });
                financeForm.reset();
                showSection('dashboard-section');
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        });

        // Event listener untuk form edit data
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const date = document.getElementById('edit-date').value;
            const category = document.getElementById('edit-category').value;
            const amount = parseFloat(document.getElementById('edit-amount').value);
            const description = document.getElementById('edit-description').value;
            
            try {
                const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId()}/financial_reports`, id);
                await window.setDoc(docRef, { date, category, amount, description }, { merge: true });
                modal.classList.add('hidden');
            } catch (error) {
                console.error("Error updating document: ", error);
            }
        });

        // Event listener untuk filter tanggal
        filterDateInput.addEventListener('change', () => {
            const loadingRow = document.getElementById('loading-row');
            if (loadingRow) loadingRow.style.display = 'table-row';
            
            const q = window.query(window.collection(window.db, `artifacts/${window.appId}/users/${window.userId()}/financial_reports`), window.where('date', '==', filterDateInput.value));
            window.onSnapshot(q, (snapshot) => {
                const data = [];
                snapshot.forEach(doc => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                renderTable(data);
            }, (error) => {
                console.error("Error filtering data: ", error);
            });
        });

        // Fungsi untuk meng-handle aksi edit dan hapus
        const handleAction = async (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const id = e.target.dataset.id;
                const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId()}/financial_reports`, id);
                const docSnap = await window.getDoc(docRef);
                if (docSnap.exists()) {
                    const itemToEdit = docSnap.data();
                    document.getElementById('edit-id').value = id;
                    document.getElementById('edit-date').value = itemToEdit.date;
                    document.getElementById('edit-category').value = itemToEdit.category;
                    document.getElementById('edit-amount').value = itemToEdit.amount;
                    document.getElementById('edit-description').value = itemToEdit.description;
                    modal.classList.remove('hidden');
                }
            } else if (e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                showConfirmModal("Apakah Anda yakin ingin menghapus data ini?", "Konfirmasi Hapus", async () => {
                    try {
                        const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId()}/financial_reports`, id);
                        await window.deleteDoc(docRef);
                    } catch (error) {
                        console.error("Error removing document: ", error);
                    }
                });
            }
        };

        // Event listener untuk tabel transaksi
        financeTableBody.addEventListener('click', handleAction);

        // Event listener untuk menutup modal
        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // ===============================================
        // USER MANAGEMENT
        // ===============================================
        let editingUserId = null;

        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const role = document.getElementById('user-role').value;
            
            try {
                // Mengubah jalur koleksi pengguna dari publik ke jalur privat yang terikat pada userId
                // Ini mengatasi masalah izin Firebase.
                if (editingUserId) {
                    const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId()}/users`, editingUserId);
                    await window.setDoc(docRef, { username, role }, { merge: true });
                    editingUserId = null;
                } else {
                    const newUserDocRef = window.doc(window.collection(window.db, `artifacts/${window.appId}/users/${window.userId()}/users`));
                    await window.setDoc(newUserDocRef, { username, role, id: newUserDocRef.id });
                }
                userForm.reset();
            } catch (error) {
                console.error("Error saving user: ", error);
            }
        });

        usersTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-user-btn')) {
                const id = e.target.dataset.id;
                const username = e.target.dataset.username;
                const role = e.target.dataset.role;
                document.getElementById('username').value = username;
                document.getElementById('user-role').value = role;
                document.getElementById('user-id').value = id;
                editingUserId = id;
            } else if (e.target.classList.contains('delete-user-btn')) {
                const id = e.target.dataset.id;
                showConfirmModal("Apakah Anda yakin ingin menghapus pengguna ini?", "Konfirmasi Hapus Pengguna", async () => {
                    try {
                        // Mengubah jalur koleksi pengguna dari publik ke jalur privat yang terikat pada userId
                        // Ini mengatasi masalah izin Firebase.
                        const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId()}/users`, id);
                        await window.deleteDoc(docRef);
                    } catch (error) {
                        console.error("Error deleting user: ", error);
                    }
                });
            }
        });
        
        // ===============================================
        // CHART PERIOD SWITCH
        // ===============================================

        dailyBtn.addEventListener('click', () => {
            window.currentChartPeriod = 'daily';
            dailyBtn.classList.add('bg-blue-600', 'text-white');
            monthlyBtn.classList.remove('bg-blue-600', 'text-white');
            window.updateChart();
        });

        monthlyBtn.addEventListener('click', () => {
            window.currentChartPeriod = 'monthly';
            monthlyBtn.classList.add('bg-blue-600', 'text-white');
            dailyBtn.classList.remove('bg-blue-600', 'text-white');
            window.updateChart();
        });


        // ===============================================
        // EXPORT FUNCTIONALITY
        // ===============================================

        // Fungsi untuk ekspor ke PDF
        exportPdfBtn.addEventListener('click', async () => {
            const data = [];
            const q = window.query(window.collection(window.db, `artifacts/${window.appId}/users/${window.userId()}/financial_reports`));
            const querySnapshot = await window.getDocs(q);
            querySnapshot.forEach(doc => {
                data.push(doc.data());
            });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Laporan Keuangan POMG SD Pembangunan Aljabbar", 14, 22);
            doc.setFontSize(12);
            doc.text("Daftar Transaksi", 14, 30);

            const tableColumn = ["Tanggal", "Kategori", "Nominal (Rp)", "Deskripsi"];
            const tableRows = data.map(item => [
                item.date,
                item.category,
                `Rp ${item.amount.toLocaleString('id-ID')}`,
                item.description
            ]);

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                theme: 'striped',
                headStyles: { fillColor: [30, 144, 255] },
            });
            doc.save('laporan_keuangan.pdf');
        });

        // Fungsi untuk ekspor ke CSV
        exportCsvBtn.addEventListener('click', async () => {
            const data = [];
            const q = window.query(window.collection(window.db, `artifacts/${window.appId}/users/${window.userId()}/financial_reports`));
            const querySnapshot = await window.getDocs(q);
            querySnapshot.forEach(doc => {
                data.push(doc.data());
            });

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header CSV
            csvContent += "Tanggal,Kategori,Nominal,Deskripsi\n";
            
            // Data CSV
            data.forEach(item => {
                const row = [item.date, item.category, item.amount, item.description].map(d => {
                    // Wrap with double quotes if the value contains a comma
                    return typeof d === 'string' && d.includes(',') ? `"${d}"` : d;
                }).join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "laporan_keuangan.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // ===============================================
        // IMPORT CSV FUNCTIONALITY
        // ===============================================
        importCsvBtn.addEventListener('click', () => {
            csvFileInput.click();
        });

        // Event listener untuk tombol "Unduh Contoh CSV"
        downloadCsvSample.addEventListener('click', (e) => {
            e.preventDefault();
            const csvData = `Tanggal,Kategori,Nominal,Deskripsi\n2023-09-01,Pemasukan,1500000,Donasi dari Bapak Budi\n2023-09-05,Pengeluaran,500000,"Pembelian alat tulis, spidol, dan kertas"\n2023-09-10,Pemasukan,250000,Iuran bulanan\n2023-09-15,Pengeluaran,750000,Biaya operasional\n2023-09-20,Pemasukan,1000000,"Sumbangan dari orang tua siswa, Tahap 1"`;
            const encodedUri = encodeURI(`data:text/csv;charset=utf-8,${csvData}`);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "contoh_laporan.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            importCsvBtn.disabled = true;
            importCsvText.classList.add('hidden');
            importCsvLoading.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');

                // Check for a valid header to ensure the file is correctly formatted.
                const header = lines[0].toLowerCase().replace(/\s/g, '');
                if (!header.startsWith('tanggal,kategori,nominal,deskripsi')) {
                    showConfirmModal("Format CSV tidak valid. Harap gunakan format: Tanggal,Kategori,Nominal,Deskripsi", "Kesalahan Impor", () => {});
                    importCsvBtn.disabled = false;
                    importCsvText.classList.remove('hidden');
                    importCsvLoading.classList.add('hidden');
                    return;
                }

                const dataRows = lines.slice(1);
                
                let successCount = 0;
                let errorCount = 0;

                for (const row of dataRows) {
                    // Use a regex to correctly split the row, handling commas inside quoted fields.
                    const parts = row.match(/(?:[^,"]+|"(?:\\.|[^"])*")+/g);
                    
                    if (!parts || parts.length < 4) {
                        errorCount++;
                        continue;
                    }
                    
                    const date = parts[0].trim().replace(/^"|"$/g, '');
                    const category = parts[1].trim().replace(/^"|"$/g, '');
                    const amountStr = parts[2].trim().replace(/^"|"$/g, '');
                    const description = parts.slice(3).join(',').trim().replace(/^"|"$/g, '');
                    const amount = parseFloat(amountStr);
                    
                    if (date && (category === 'Pemasukan' || category === 'Pengeluaran') && !isNaN(amount) && amount > 0) {
                        try {
                            const financeColRef = window.collection(window.db, `artifacts/${window.appId}/users/${window.userId()}/financial_reports`);
                            await window.addDoc(financeColRef, {
                                date,
                                category,
                                amount,
                                description,
                                createdAt: new Date().toISOString()
                            });
                            successCount++;
                        } catch (error) {
                            console.error("Error adding imported document:", error);
                            errorCount++;
                        }
                    } else {
                        errorCount++;
                    }
                }
                
                showConfirmModal(
                    `Impor selesai. Berhasil: ${successCount} data, Gagal: ${errorCount} data.`, 
                    "Status Impor", 
                    () => {}
                );

                importCsvBtn.disabled = false;
                importCsvText.classList.remove('hidden');
                importCsvLoading.classList.add('hidden');
            };

            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        });

        // ===============================================
        // GEMINI API INTEGRATIONS
        // ===============================================

        async function callGeminiAPI(prompt, isStructured = false, isGrounded = false, retries = 3) {
            const modelName = 'gemini-2.5-flash-preview-05-20';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${""}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {}
            };

            if (isGrounded) {
                payload.tools = [{ "google_search": {} }];
            }

            if (isStructured) {
                payload.generationConfig.responseMimeType = "application/json";
                payload.generationConfig.responseSchema = {
                    "type": "OBJECT",
                    "properties": {
                        "pemasukan": { "type": "NUMBER" },
                        "pengeluaran": { "type": "NUMBER" },
                        "tabungan": { "type": "NUMBER" },
                        "lain_lain": { "type": "NUMBER" },
                        "summary": { "type": "STRING" }
                    },
                    "propertyOrdering": ["pemasukan", "pengeluaran", "tabungan", "lain_lain", "summary"]
                };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        const delay = Math.pow(2, 4 - retries) * 1000 + Math.random() * 1000;
                        await new Promise(res => setTimeout(res, delay));
                        return callGeminiAPI(prompt, isStructured, isGrounded, retries - 1);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (isStructured && candidate?.content?.parts?.[0]?.text) {
                     return JSON.parse(candidate.content.parts[0].text);
                } else if (candidate?.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    throw new Error("Invalid response from Gemini API.");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        }

        // Analisis Laporan Keuangan
        analyzeReportBtn.addEventListener('click', async () => {
            const data = [];
            const q = window.query(window.collection(window.db, `artifacts/${window.appId}/users/${window.userId()}/financial_reports`));
            const querySnapshot = await window.getDocs(q);
            querySnapshot.forEach(doc => {
                data.push(doc.data());
            });

            if (data.length === 0) {
                analysisResultDiv.classList.remove('hidden');
                analysisTextEl.textContent = "Tidak ada data untuk dianalisis.";
                return;
            }

            analyzeReportBtn.disabled = true;
            analyzeReportText.classList.add('hidden');
            analyzeReportLoading.classList.remove('hidden');

            const reportText = JSON.stringify(data);
            const prompt = `Tolong berikan ringkasan analisis singkat (dalam satu paragraf) dari laporan keuangan berikut. Jelaskan tren, soroti total pemasukan dan pengeluaran, serta berikan kesimpulan tentang kesehatan keuangan. Gunakan bahasa yang profesional dan mudah dimengerti. Berikut datanya: ${reportText}`;

            try {
                const analysis = await callGeminiAPI(prompt);
                analysisResultDiv.classList.remove('hidden');
                analysisTextEl.textContent = analysis;
            } catch (error) {
                analysisTextEl.textContent = "Terjadi kesalahan saat menganalisis laporan. Silakan coba lagi.";
                console.error(error);
            } finally {
                analyzeReportBtn.disabled = false;
                analyzeReportText.classList.remove('hidden');
                analyzeReportLoading.classList.add('hidden');
            }
        });

        // Saran Anggaran Cerdas
        generateBudgetBtn.addEventListener('click', async () => {
            const totalIncomeStr = document.getElementById('total-income').textContent;
            const totalIncome = parseFloat(totalIncomeStr.replace(/[Rp\s,.]/g, '') || '0');

            if (totalIncome === 0) {
                budgetSuggestionEl.textContent = "Total pemasukan Anda Rp 0. Silakan tambahkan data pemasukan terlebih dahulu untuk mendapatkan saran anggaran.";
                return;
            }

            generateBudgetBtn.disabled = true;
            generateBudgetText.classList.add('hidden');
            generateBudgetLoading.classList.remove('hidden');

            const prompt = `Berikan saran anggaran bulanan untuk total pemasukan sebesar Rp ${totalIncome.toLocaleString('id-ID')}. Berikan saran alokasi untuk kategori 'pemasukan', 'pengeluaran', 'tabungan', dan 'lain_lain' sebagai persentase dari total pemasukan. Pastikan total persentase adalah 100%. Setelah itu, berikan ringkasan singkat dalam satu kalimat. Tampilkan hasilnya dalam format JSON.`;

            try {
                const budgetData = await callGeminiAPI(prompt, true);
                const pemasukan = (budgetData.pemasukan * totalIncome) / 100;
                const pengeluaran = (budgetData.pengeluaran * totalIncome) / 100;
                const tabungan = (budgetData.tabungan * totalIncome) / 100;
                const lain_lain = (budgetData.lain_lain * totalIncome) / 100;
                const summary = budgetData.summary;

                const suggestionText = `
                    <p>Berdasarkan total pemasukan Anda sebesar ${totalIncomeStr}, berikut adalah saran anggaran bulanan:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Pemasukan: Rp ${pemasukan.toLocaleString('id-ID')} (${budgetData.pemasukan}%)</li>
                        <li>Pengeluaran: Rp ${pengeluaran.toLocaleString('id-ID')} (${budgetData.pengeluaran}%)</li>
                        <li>Tabungan: Rp ${tabungan.toLocaleString('id-ID')} (${budgetData.tabungan}%)</li>
                        <li>Lain-lain: Rp ${lain_lain.toLocaleString('id-ID')} (${budgetData.lain_lain}%)</li>
                    </ul>
                    <p class="mt-4 font-semibold">${summary}</p>
                `;
                budgetSuggestionEl.innerHTML = suggestionText;

            } catch (error) {
                budgetSuggestionEl.textContent = "Terjadi kesalahan saat membuat saran anggaran. Silakan coba lagi.";
                console.error(error);
            } finally {
                generateBudgetBtn.disabled = false;
                generateBudgetText.classList.remove('hidden');
                generateBudgetLoading.classList.add('hidden');
            }
        });
    });
</script>

</body>
</html>
